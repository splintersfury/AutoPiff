{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "AutoPiff Stage 2: Symbolization & Anchoring",
    "type": "object",
    "required": [
        "autopiff_stage",
        "driver_new",
        "driver_old",
        "symbolization"
    ],
    "properties": {
        "autopiff_stage": {
            "type": "string",
            "const": "symbols"
        },
        "driver_new": {
            "type": "object",
            "required": ["sha256", "function_count", "source_path"],
            "properties": {
                "sha256": {
                    "type": "string",
                    "pattern": "^[a-fA-F0-9]{64}$"
                },
                "function_count": {
                    "type": "integer",
                    "minimum": 0
                },
                "source_path": {
                    "type": ["string", "null"],
                    "description": "Path or MWDB reference to decompiled source"
                },
                "pdb_found": {
                    "type": "boolean",
                    "default": false
                }
            }
        },
        "driver_old": {
            "type": "object",
            "required": ["sha256", "function_count", "source_path"],
            "properties": {
                "sha256": {
                    "type": "string",
                    "pattern": "^[a-fA-F0-9]{64}$"
                },
                "function_count": {
                    "type": "integer",
                    "minimum": 0
                },
                "source_path": {
                    "type": ["string", "null"]
                },
                "pdb_found": {
                    "type": "boolean",
                    "default": false
                }
            }
        },
        "symbolization": {
            "type": "object",
            "required": ["method", "coverage", "anchors"],
            "properties": {
                "method": {
                    "type": "string",
                    "enum": ["ghidra_decompile", "pdb", "bsim", "function_id"],
                    "description": "Primary symbolization method used"
                },
                "coverage": {
                    "type": "number",
                    "minimum": 0.0,
                    "maximum": 1.0,
                    "description": "Fraction of functions with stable names"
                },
                "anchors": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "required": ["name", "addr_new", "addr_old", "confidence"],
                        "properties": {
                            "name": {
                                "type": "string"
                            },
                            "addr_new": {
                                "type": "string"
                            },
                            "addr_old": {
                                "type": "string"
                            },
                            "confidence": {
                                "type": "number",
                                "minimum": 0.0,
                                "maximum": 1.0
                            }
                        }
                    },
                    "description": "High-confidence anchor functions for alignment"
                }
            }
        },
        "notes": {
            "type": "array",
            "items": {
                "type": "string"
            }
        }
    }
}
